---
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/NavBar.astro';
import '../../styles/global.css';

const posts = import.meta.glob<any>('../posts/*.md', { eager: true });
const allPosts = Object.values(posts);
const sortedPosts = allPosts.sort(
  (a: any, b: any) =>
    new Date(b.frontmatter.date).getTime() -
    new Date(a.frontmatter.date).getTime()
);

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}
---

<Layout>
  <NavBar />
  <main class="max-w-3xl mx-auto px-6 py-12">
    <div class="mb-12">
      <h1 class="text-3xl md:text-4xl font-bold mb-3">Blogs</h1>
      <p class="text-base text-[var(--text-secondary)] mb-6 space-mono-regular">
        writing about systems, performance, and the craft of building software
      </p>

      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder="Search blogs..."
          class="w-full px-4 py-3 bg-[var(--bg-surface)] border border-[var(--border)] rounded-none text-[var(--text-primary)] placeholder:text-[var(--text-secondary)] focus:outline-none focus:ring-1 focus:ring-[var(--text-primary)] transition-all space-mono-regular"
        />
      </div>
    </div>

    {
      sortedPosts.length > 0 ? (
        <div
          id="posts-container"
          class="flex flex-col border-t border-[var(--border)]"
        >
          {sortedPosts.map(post => (
            <article
              class="post-item group border-b border-[var(--border)] py-6 hover:bg-[var(--bg-surface)] transition-colors"
              data-search-text={`${post.frontmatter.title.toLowerCase()} ${post.frontmatter.description.toLowerCase()} ${post.frontmatter.tags?.join(' ').toLowerCase() || ''}`}
            >
              <a href={post.url} class="block">
                <div class="flex flex-col sm:flex-row sm:items-baseline justify-between gap-2 mb-2">
                  <h2 class="text-xl md:text-2xl font-bold text-[var(--text-primary)] group-hover:underline decoration-1 underline-offset-4">
                    {post.frontmatter.title}
                  </h2>
                  <time class="text-sm text-[var(--text-secondary)] space-mono-regular whitespace-nowrap flex-shrink-0">
                    {formatDate(post.frontmatter.date)}
                  </time>
                </div>

                <p class="text-[var(--text-secondary)] mb-3 leading-relaxed space-mono-regular text-sm sm:text-base max-w-2xl">
                  {post.frontmatter.description}
                </p>

                {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2 mt-3">
                    {post.frontmatter.tags.map((tag: string) => (
                      <span class="text-xs text-[var(--text-secondary)] border border-[var(--border)] px-2 py-0.5 space-mono-regular">
                        #{tag}
                      </span>
                    ))}
                  </div>
                )}
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-[var(--text-secondary)] space-mono-regular">
            No posts yet. Check back soon.
          </p>
        </div>
      )
    }

    <div id="no-results" class="hidden text-center py-16">
      <p class="text-[var(--text-secondary)] space-mono-regular">
        No blogs found matching your search.
      </p>
    </div>
  </main>
</Layout>

<script>
  const searchInput = document.getElementById(
    'search-input'
  ) as HTMLInputElement;
  const postsContainer = document.getElementById('posts-container');
  const noResults = document.getElementById('no-results');
  const postItems = document.querySelectorAll('.post-item');

  let debounceTimer: ReturnType<typeof setTimeout>;

  function debounce(func: (...args: any[]) => void, delay: number) {
    return (...args: any[]) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func(...args), delay);
    };
  }

  function filterPosts(query: string) {
    const lowerQuery = query.toLowerCase().trim();

    if (!lowerQuery) {
      postItems.forEach(item => {
        (item as HTMLElement).style.display = '';
      });
      if (noResults) noResults.classList.add('hidden');
      if (postsContainer) postsContainer.classList.remove('hidden');
      return;
    }

    let visibleCount = 0;

    postItems.forEach(item => {
      const searchText = (item as HTMLElement).dataset.searchText || '';
      const matches = searchText.includes(lowerQuery);

      if (matches) {
        (item as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });

    if (visibleCount === 0) {
      if (noResults) noResults.classList.remove('hidden');
      if (postsContainer) postsContainer.classList.add('hidden');
    } else {
      if (noResults) noResults.classList.add('hidden');
      if (postsContainer) postsContainer.classList.remove('hidden');
    }
  }

  const debouncedFilter = debounce(filterPosts, 300);

  if (searchInput) {
    searchInput.addEventListener('input', e => {
      const target = e.target as HTMLInputElement;
      debouncedFilter(target.value);
    });
  }
</script>

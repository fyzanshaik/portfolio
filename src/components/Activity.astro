---
const GITHUB_USERNAME = 'fyzanshaik';
---

<section>
  <div class="max-w-[1100px] mx-auto px-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg md:text-xl font-bold">Activity</h2>
      <a
        href={`https://github.com/${GITHUB_USERNAME}`}
        target="_blank"
        rel="noopener noreferrer"
        class="text-xs text-[var(--text-secondary)] hover:text-[var(--accent)] transition-colors flex items-center gap-1"
      >
        View GitHub
        <svg
          class="w-3 h-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
        </svg>
      </a>
    </div>

    <div id="github-activity-list" class="space-y-4">
      <div class="animate-pulse space-y-4">
        <div class="flex flex-col md:flex-row md:items-baseline gap-1 md:gap-8">
          <div class="h-3 bg-[var(--bg-surface)] rounded w-[100px]"></div>
          <div class="flex-1">
            <div class="h-4 bg-[var(--bg-surface)] rounded w-3/4 mb-1"></div>
            <div class="h-3 bg-[var(--bg-surface)] rounded w-1/2"></div>
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-baseline gap-1 md:gap-8">
          <div class="h-3 bg-[var(--bg-surface)] rounded w-[100px]"></div>
          <div class="flex-1">
            <div class="h-4 bg-[var(--bg-surface)] rounded w-2/3 mb-1"></div>
            <div class="h-3 bg-[var(--bg-surface)] rounded w-1/3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ GITHUB_USERNAME }}>
  const CACHE_KEY = 'github-activity-cache';
  const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

  function getCachedData() {
    try {
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_TTL) {
          return data;
        }
      }
    } catch (e) {
      // Ignore cache errors
    }
    return null;
  }

  function setCachedData(data) {
    try {
      sessionStorage.setItem(
        CACHE_KEY,
        JSON.stringify({
          data,
          timestamp: Date.now(),
        })
      );
    } catch (e) {
      // Ignore cache errors
    }
  }

  function renderActivity(items) {
    const listEl = document.getElementById('github-activity-list');
    if (!listEl) return;

    if (items && items.length > 0) {
      listEl.innerHTML = items
        .map(pr => {
          const date = new Date(pr.closed_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          });

          const repoName = pr.repository_url.split('/').slice(-1)[0];

          return `
          <div class="group">
            <a href="${pr.html_url}" target="_blank" rel="noopener" class="block">
              <div class="flex flex-col md:flex-row md:items-baseline gap-1 md:gap-8">
                <span class="text-xs text-[var(--text-secondary)] font-mono whitespace-nowrap w-[100px]">${date}</span>
                <div class="flex-1">
                  <div class="flex flex-wrap items-baseline gap-2 mb-1">
                    <span class="text-base font-medium group-hover:text-[var(--accent)] transition-colors">${pr.title}</span>
                    <span class="text-[10px] text-[var(--text-secondary)] px-1.5 py-0.5 rounded bg-[var(--bg-surface)] border border-[var(--border)]">${repoName}</span>
                  </div>
                </div>
              </div>
            </a>
          </div>
        `;
        })
        .join('');
    } else {
      listEl.innerHTML =
        '<p class="text-xs text-[var(--text-secondary)]">No recent activity found.</p>';
    }
  }

  async function loadGitHubActivity() {
    const listEl = document.getElementById('github-activity-list');
    if (!listEl) return;

    // Check cache first
    const cachedData = getCachedData();
    if (cachedData) {
      renderActivity(cachedData);
      return;
    }

    try {
      const response = await fetch(
        `https://api.github.com/search/issues?q=author:${GITHUB_USERNAME}+type:pr+is:merged&sort=updated&per_page=5`
      );

      if (!response.ok) throw new Error('Failed to fetch');

      const data = await response.json();

      // Cache the results
      setCachedData(data.items);

      renderActivity(data.items);
    } catch (error) {
      console.error(error);
      if (listEl) listEl.innerHTML = ''; // Silently fail
    }
  }

  // Run on initial load and View Transitions navigation
  loadGitHubActivity();
  document.addEventListener('astro:page-load', loadGitHubActivity);
</script>

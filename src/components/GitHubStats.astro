---
const GITHUB_USERNAME = 'fyzanshaik';
---

<section>
  <div class="flex items-baseline justify-between mb-6">
    <h2 class="text-2xl font-bold">Recent Activity</h2>
    <button
      id="refresh-prs"
      class="p-2 hover:bg-[var(--bg-surface)] rounded-full transition-colors text-[var(--text-secondary)] hover:text-[var(--text-primary)]"
      aria-label="Refresh activity"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
        ></path>
      </svg>
    </button>
  </div>

  <div id="github-prs" class="flex flex-col text-sm space-mono-regular">
    <p class="text-[var(--text-secondary)]">Loading commits...</p>
  </div>
</section>

<script define:vars={{ GITHUB_USERNAME }}>
  async function loadGitHubPRs() {
    const prsEl = document.getElementById('github-prs');
    const refreshBtn = document.getElementById('refresh-prs');

    if (refreshBtn) refreshBtn.classList.add('animate-spin');

    try {
      const prsResponse = await fetch(
        `https://api.github.com/search/issues?q=author:${GITHUB_USERNAME}+type:pr+is:merged&sort=updated&per_page=5`
      );

      if (prsResponse.ok) {
        const prsData = await prsResponse.json();
        if (prsEl && prsData.items.length > 0) {
          prsEl.innerHTML = prsData.items
            .map(pr => {
              const repo = pr.repository_url.split('/').slice(-2).join('/');
              const date = new Date(pr.closed_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
              });

              return `
              <a href="${pr.html_url}" target="_blank" rel="noopener" class="group flex items-baseline justify-between py-2 border-b border-[var(--border)] last:border-0 hover:bg-[var(--bg-surface)] transition-colors">
                <div class="flex items-baseline gap-4 min-w-0">
                  <span class="text-[var(--text-secondary)] w-12 flex-shrink-0">${date}</span>
                  <span class="text-[var(--text-primary)] truncate group-hover:underline decoration-1 underline-offset-4">${pr.title}</span>
                </div>
                <span class="text-[var(--text-secondary)] text-xs ml-4 flex-shrink-0">${repo}</span>
              </a>
            `;
            })
            .join('');
        }
      }
    } catch (error) {
      console.error('Error loading GitHub PRs:', error);
      if (prsEl)
        prsEl.innerHTML =
          '<p class="text-[var(--text-secondary)]">Unable to load activity</p>';
    } finally {
      if (refreshBtn) refreshBtn.classList.remove('animate-spin');
    }
  }

  document
    .getElementById('refresh-prs')
    ?.addEventListener('click', loadGitHubPRs);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGitHubPRs);
  } else {
    loadGitHubPRs();
  }
</script>
